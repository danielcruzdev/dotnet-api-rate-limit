name: Rate Limit Test (k6)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  rate-limit-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restaurar dependências
      run: dotnet restore
      working-directory: src

    - name: Build da API
      run: dotnet build --no-restore
      working-directory: src

    - name: Subir API em background
      run: |
        cd src/Api
        dotnet run --no-build > api.log 2>&1 &
        echo "Aguardando API iniciar..."
        for i in {1..30}; do
          if curl -s http://localhost:5189/with-rate-limit/weather-forecast > /dev/null 2>&1; then
            echo "API está pronta!"
            break
          fi
          echo "Tentativa $i de 30..."
          sleep 1
        done
        sleep 2

    - name: Setup k6
      uses: grafana/setup-k6-action@v1

    - name: Executar teste de Rate Limit
      run: k6 run tests/k6/rate-limit-test.js
